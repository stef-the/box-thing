<script>
	import { onMount } from "svelte";

	export const size = [23, 11];
	export let coords = [11, 5];
	export let generatorcoords = [];
	export let tempintA = 0;
	export let tempintB = 0;
	export let target = 0;
	export let temptarget = 0;
	export const movementInputs = ['w', 'a', 's', 'd', 'ArrowUp', 'ArrowLeft', 'ArrowDown', 'ArrowRight'];
	export let frozen = false;
	export let gameboard = buildgame(size[0], size[1]);

	function randomNumber(min, max) { return Math.floor(Math.random() * (max - min) + min); }

	function buildgame (a, b) {
		let templistA;
		let templistB = [];
		for (let i = 0; i < b; i++) {
			templistA = [];
			for (let j = 0; j < a; j++) {
				templistA.push(0);
			}
			templistB.push(templistA);
		}
		return templistB;
	};

	function generategame (a, b) {
		for (let i in gameboard) {
			for (let j in gameboard[i]) {
				gameboard[i][j] = randomNumber(a, b)
			}
		}
	}

	function generategameOLD (a, b) {
		generatorcoords = [randomNumber(0, size[0]), randomNumber(0, size[1])];
		coords = generatorcoords;
		temptarget = randomNumber(a, b);
		gameboard[generatorcoords[1]][generatorcoords[0]] = temptarget;
		target += temptarget;
		do {
			tempintA = (Math.random()>=0.5)? 1 : -1;
			tempintB = randomNumber(0, 2)
			generatorcoords[tempintB] += tempintA
			console.log(gameboard)
			console.log(generatorcoords)
			if (gameboard[generatorcoords[0]][generatorcoords[1]] == 0)  {
				temptarget = randomNumber(a, b);
				gameboard[generatorcoords[1]][generatorcoords[0]] = temptarget;
				target += temptarget;
			} else { generatorcoords[tempintB] -= tempintA}

			console.log(generatorcoords);
		} while (
			generatorcoords[0] > 0 && generatorcoords[0] < size[0] - 1 &&
			generatorcoords[1] > 0 && generatorcoords[1] < size[1] - 1
		);
		target -= temptarget;
		console.log(temptarget)
		gameboard[generatorcoords[1]][generatorcoords[0]] = target;
		console.log('generatorcoords');
	}

	function game (id) {
		const container = document.getElementById(id);
		container.innerHTML = '';
		let temp = '';
		generategame(1, 5)

		for (let i in gameboard) {
			for (let j in gameboard[i]) {
				temp += `<div id="block${i}-${j}" class="h-5 w-5 m-2 text-sm bg-red-300 hover:bg-yellow-200 flex flex-wrap justify-center items-center">${(!isNaN(gameboard[i][j])) ? gameboard[i][j] : ""}</div>`
			}
			temp += '<div class="w-full"></div>'
		}
		container.innerHTML += temp;
		stoggle()
	};

	let body = document.getElementsByTagName('body')[0];

	body.addEventListener("keydown", onkeydown_handler)
	body.addEventListener("keyup", onkeyup_handler)

	function onkeydown_handler (event) {
		if (movementInputs.includes(event.key) && !frozen) {
			let id;
			if ('wasd'.includes(event.key)) {
				id = event.key;
			} else {
				id = (
					(event.key == 'ArrowUp') ? 'w' : (
						(event.key == 'ArrowLeft') ? 'a' : (
							(event.key == 'ArrowDown') ? 's' : 'd')
					)
				)
			}
			let button = document.getElementById(id);
			button.classList.toggle('text-red-300')
			button.classList.toggle('bg-gray-500')
			button.classList.toggle('text-yellow-300')
			button.classList.toggle('bg-gray-600')
			if (event.key === 'w' || event.key === 'ArrowUp') { up('block') } 
			else if (event.key === 'a' || event.key === 'ArrowLeft') { left('block') }
			else if (event.key === 's' || event.key === 'ArrowDown') { down('block') }
			else if (event.key === 'd' || event.key === 'ArrowRight') { right('block') }
		} else if (event.key === 'Enter' || event.key === ' ') {
			let item = document.getElementById(`block${coords[1]}-${coords[0]}`)
			item.classList.toggle('m-2')
			item.classList.toggle('h-5')
			item.classList.toggle('w-5')
			item.classList.toggle('text-sm')
			
			item.classList.toggle('m-1')
			item.classList.toggle('h-7')
			item.classList.toggle('w-7')
			item.classList.toggle('text-base')
			item.classList.toggle('font-semibold')

			frozen = true;
		} else { console.log('keydown: ' + event.key) }
	}

	function onkeyup_handler (event) {
		if (movementInputs.includes(event.key) && !frozen) {
			let id;
			if ('wasd'.includes(event.key)) {
				id = event.key;
			} else {
				id = (
					(event.key === 'ArrowUp') ? 'w' : (
						(event.key === 'ArrowLeft') ? 'a' : (
							(event.key === 'ArrowDown') ? 's' : 'd')
					)
				)
			}
			let button = document.getElementById(id);
			button.classList.toggle('text-red-300')
			button.classList.toggle('bg-gray-500')
			button.classList.toggle('text-yellow-300')
			button.classList.toggle('bg-gray-600')
		} else if (event.key === 'Enter' || event.key === ' ') {
			let item = document.getElementById(`block${coords[1]}-${coords[0]}`)
			item.classList.toggle('m-2')
			item.classList.toggle('h-5')
			item.classList.toggle('w-5')
			item.classList.toggle('text-sm')

			item.classList.toggle('m-1')
			item.classList.toggle('h-7')
			item.classList.toggle('w-7')
			item.classList.toggle('text-base')
			item.classList.toggle('font-semibold')

			frozen = false;
		} else { console.log('keyup: ' + event.key) }
	}

	function stoggle () {
		let item = document.getElementById(`block${coords[1]}-${coords[0]}`)

		item.classList.toggle('bg-red-300')
		item.classList.toggle('hover:bg-yellow-200')
		item.classList.toggle('m-2')
		item.classList.toggle('h-5')
		item.classList.toggle('w-5')
		item.classList.toggle('text-sm')

		item.classList.toggle('bg-gray-300')
		item.classList.toggle('hover:bg-gray-400')
		item.classList.toggle('m-1')
		item.classList.toggle('h-7')
		item.classList.toggle('w-7')
		item.classList.toggle('text-base')
		item.classList.toggle('font-semibold')
	}

	function up () {
		stoggle()
		if (coords[1] > 0) { coords[1] -= 1 }
		stoggle()
	}

	function left () {
		stoggle()
		if (coords[0] > 0) { coords[0] -= 1 }
		stoggle()
	}

	function down () {
		stoggle()
		if (coords[1] < size[1] - 1) { coords[1] += 1 } 
		stoggle()
	}

	function right () {
		stoggle()
		if (coords[0] < size[0] - 1) { coords[0] += 1 }
		stoggle()
	}

	onMount(() => game('app'))
</script>

<main class="flex justify-center flex-wrap text-xs">
	<div id="app" class="w-full flex flex-wrap justify-center m-10"></div>
	<div id="controls" class="flex justify-center flex-wrap">
		<button id="w" on:click={() => up('block')} class="text-red-300 active:text-yellow-300 active:bg-gray-600 bg-gray-500 m-1 w-7 h-7">↑</button>
		<div id="controlrow" class="flex justify-center w-full">
			<button id="a" on:click={() => left('block')} class="text-red-300 active:text-yellow-300 active:bg-gray-600 bg-gray-500 m-1 w-7 h-7">←</button>
			<button id="s" on:click={() => down('block')} class="text-red-300 active:text-yellow-300 active:bg-gray-600 bg-gray-500 m-1 w-7 h-7">↓</button>
			<button id="d" on:click={() => right('block')} class="text-red-300 active:text-yellow-300 active:bg-gray-600 bg-gray-500 m-1 w-7 h-7">→</button>
		</div>
	</div>
	
</main>
